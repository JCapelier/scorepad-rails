<div class="w-full max-w-md mx-auto px-4 py-8" data-controller="autocomplete">
  <div class="mb-8">
    <h1 class="font-bold text-xl text-center"><%= @game.title %></h1>
  </div>

  <h2 class="text-2xl font-bold text-purple-700 mb-6 text-center">Start a New Game Session</h2>

  <%= simple_form_for @session do |f| %>
    <%= f.hidden_field :game_id, value: @game.id %>

    <div class="space-y-5" >
      <div>
        <%= f.label :location, "Where are you playing?", class: "block text-sm font-medium text-gray-800 mb-1" %>
        <%= f.input_field :location,
            class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500" %>
      </div>

      <% if @custom_rules %>
        <div class="mb-6 p-4 bg-purple-50 rounded" data-controller="rules">
          <h3 class="font-bold text-lg mb-3 text-purple-700">Custom Rules</h3>
          <% @custom_rules.each do |key, rule| %>
            <div class="mb-3 flex flex-col gap-2">
              <% if rule["type"] == "checkbox" %>
                <div class="flex items-center">
                  <%= check_box_tag "custom_rules[#{key}][value]", true, false, id: "custom_rule_#{key}", data: { rules_target: "parent" } %>
                  <%= label_tag "custom_rule_#{key}", rule["label"], class: "ml-2" %>
                </div>
                <% if rule["subrules"] %>
                  <% rule["subrules"].each do |subkey, subrule| %>
                    <% if subrule["type"] == "checkbox" %>
                      <div class="flex items-center ml-6">
                        <%= check_box_tag "custom_rules[#{key}][subrules][#{subkey}]", true, false, id: "custom_rule_#{key}_#{subkey}", data: { rules_target: "subrule", parent_id: "custom_rule_#{key}" } %>
                        <%= label_tag "custom_rule_#{key}_#{subkey}", subrule["label"], class: "ml-2" %>
                      </div>
                    <% elsif subrule["type"] == "number" %>
                      <%= label_tag "custom_rules[#{key}_#{subkey}]", subrule["label"], class: "block mb-1 ml-6" %>
                      <%= number_field_tag "custom_rules[#{key}][subrules][#{subkey}]", nil, min: 0, class: "w-full px-3 py-2 border rounded-md ml-6" %>
                    <% elsif subrule["type"] == "input" %>
                      <%= label_tag "custom_rules[#{key}_#{subkey}]", subrule["label"], class: "block mb-1 ml-6" %>
                      <%= text_field_tag "custom_rules[#{key}][subrules][#{subkey}]", nil, class: "w-full px-3 py-2 border rounded-md ml-6" %>
                    <% end %>
                  <% end %>
                <% end %>
              <% elsif rule["type"] == "number" %>
                <%= label_tag "custom_rules[#{key}][value]", rule["label"], class: "block mb-1" %>
                <%= number_field_tag "custom_rules[#{key}]", nil, min: 0, class: "w-full px-3 py-2 border rounded-md" %>
              <% elsif rule["type"] == "input" %>
                <%= label_tag "custom_rules[#{key}][value]", rule["label"], class: "block mb-1" %>
                <%= text_field_tag "custom_rules[#{key}]", nil, class: "w-full px-3 py-2 border rounded-md" %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <div>
        <%= label_tag :player_search, "Add player by username", class: "block text-sm font-medium text-gray-800 mb-1" %>
        <%= text_field_tag :player_search, "", class: "w-full px-3 py-2 border rounded-md", data: { autocomplete_target: "input", action: "keyup->autocomplete#search" } %>
        <div data-autocomplete-target="results" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <div data-autocomplete-target="selected" class="flex flex-wrap gap-2">
      </div>

      <div class="text-center">
        <button type="button"
          data-autocomplete-target="submit"
          data-action="click->autocomplete#createList"
          onclick="my_modal_3.showModal()"
          class="bg-yellow-300 hover:bg-yellow-400 text-purple-900 font-semibold px-4 py-2 rounded-md",
          data-autocomplete_target="submit"
          data-max_players="#{@game.max_players}"
          data-min_players="#{@game.min_players}"
          disabled>
          Seat the players
        </button>

        <dialog id="my_modal_3" class="modal">
          <div class="modal-box">
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="my_modal_3.close()">âœ•</button>
            <h3 class="font-bold text-lg mb-4 text-center">Set Player Positions</h3>
            <div data-autocomplete-target="sortableList"></div>
            <button type="submit"
              form="new_game_session"
              class="bg-purple-700 hover:bg-purple-800 text-white font-semibold px-4 py-2 rounded-md mt-6 w-full">
              Start Game Session
            </button>
          </div>
        </dialog>
      </div>
    </div>
  <% end %>

</div>
