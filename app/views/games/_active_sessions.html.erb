<% if active_sessions.present? %>
  <div class="w-full max-w-5xl mx-auto mt-8">
    <h2 class="text-xl font-bold text-center mb-4">Active Game Sessions</h2>
    <div class="space-y-4">
      <% active_sessions.each do |session| %>
        <div class="bg-white shadow rounded-lg px-6 py-4 flex flex-col">
          <div class="flex flex-row items-start justify-between w-full mb-2">
            <div class="flex-1 flex items-center">
              <span class="font-bold text-purple-700 text-lg"><%= session.game.title %></span>
            </div>
            <div class="flex-1 flex items-center justify-center">
              <span class="text-gray-700 font-semibold">Location:</span>
              <span class="ml-2 text-gray-700"><%= session.location.presence || 'N/A' %></span>
            </div>
            <div class="flex-1 flex flex-col items-end">
              <span class="text-sm text-gray-500 text-right"><%= session.starts_at.strftime('%d/%m/%Y') %></span>
              <span class="text-sm text-gray-500 text-right w-full" style="margin-top:-2px;"><%= session.starts_at.strftime('%H:%M') %></span>
            </div>
          </div>
          <div class="flex flex-row items-center justify-center w-full mb-2">
            <% rules = session.scoresheet&.data&.select { |k, v| v.is_a?(Hash) && v["value"] == true } || {} %>
            <% if rules.present? %>
              <% rules.each do |key, rule| %>
                <span class="badge badge-outline badge-sm mx-1"><%= key.to_s.titleize %></span>
                <% if rule["subrules"] %>
                  <% rule["subrules"].each do |subkey, subval| %>
                    <% if subval == true %>
                      <span class="badge badge-outline badge-sm mx-1"><%= subkey.to_s.titleize %></span>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% else %>
              <span class="badge badge-outline badge-sm mx-1">Standard</span>
            <% end %>
          </div>
          <div class="flex flex-wrap items-center justify-center gap-4 mt-2">
            <% session.session_players.each do |sp| %>
              <div class="flex flex-col items-center bg-gray-100 rounded px-2 py-1" style="width:70px;">
                <% if sp.user.avatar_url.present? %>
                  <img src="<%= sp.user.avatar_url %>" alt="avatar" class="w-10 h-10 rounded-full border mb-1" />
                <% else %>
                  <div class="w-10 h-10 rounded-full border mb-1 bg-gray-300 flex items-center justify-center text-gray-500">?</div>
                <% end %>
                <span class="text-xs font-semibold text-center w-full truncate"><%= sp.user.username %></span>
              </div>
            <% end %>
          </div>
          <div class="mt-3 text-center">
            <% if session.scoresheet %>
              <%= link_to "Resume", scoresheet_path(session.scoresheet), class: "btn btn-primary w-32", data: { turbo: "false" } %>
            <% end %>
      <%= link_to "Delete",
        game_session_path(session),
        method: :delete,
        class: "btn btn-primary w-32",
        data: { turbo_confirm: "Are you sure?" } %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% else %>
  <!-- No active sessions -->
<% end %>
